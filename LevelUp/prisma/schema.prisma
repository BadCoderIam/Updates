generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Track {
  IT_SUPPORT
}

enum StartingPosition {
  HELPDESK_SUPPORT
  DESKTOP_TECHNICIAN
  CLOUD_ENGINEER
}

enum ModuleChoice {
  INTERVIEW
  CERTIFICATIONS
  PRO_DEV
}

enum NotificationType {
  HR_INVITE
  TECH_INTERVIEW_READY
  BADGE_EXPIRES_SOON
}

enum InterviewKind {
  HR
  TECH
}

enum InterviewStatus {
  IN_PROGRESS
  FINISHED
}

enum TurnSpeaker {
  INTERVIEWER
  CANDIDATE
}

enum CertExam {
  A_PLUS
  SECURITY_PLUS
  AZ_900
}

model User {
  id               String            @id
  email            String
  displayName      String?
  startingPosition StartingPosition?
  moduleChoice     ModuleChoice?
  xp               Int               @default(0)
  createdAt        DateTime          @default(now())
  lastActiveAt     DateTime?

  practiceAnswers PracticeAnswer[]
  certAnswers     CertPracticeAnswer[]
  domains         UserDomain[]
  interviews      InterviewSession[]
  notifications   Notification[]
  badges          Badge[]
  offers          MockOffer[]
}

model PracticeAnswer {
  id           String   @id @default(cuid())
  userId       String
  track        Track
  tier         Int
  domain       String
  prompt       String
  answer       String
  scoreTotal   Float
  xpAwarded    Int
  breakdownJson Json
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
  @@index([userId, domain])
}

model CertPracticeAnswer {
  id        String   @id @default(cuid())
  userId    String
  exam      CertExam
  prompt    String
  answer    String
  xpAwarded Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
  @@index([userId, exam])
}

model UserDomain {
  id              String   @id @default(cuid())
  userId          String
  domain          String
  xp              Int      @default(0)
  lastPracticedAt DateTime?

  user User @relation(fields: [userId], references: [id])

  @@unique([userId, domain], name: "userId_domain")
  @@index([userId, xp])
}

model InterviewSession {
  id         String          @id @default(cuid())
  userId     String
  kind       InterviewKind
  status     InterviewStatus
  startedAt  DateTime
  finishedAt DateTime?
  pass       Boolean?
  scoreAvg   Float?
  summary    String?

  turns      InterviewTurn[]

  user User @relation(fields: [userId], references: [id])
  @@index([userId, kind, startedAt])
}

model InterviewTurn {
  id            String   @id @default(cuid())
  sessionId     String
  speaker       TurnSpeaker @default(CANDIDATE)
  content       String
  turnIndex     Int
  scoreTotal    Float
  breakdownJson Json
  createdAt     DateTime @default(now())

  session InterviewSession @relation(fields: [sessionId], references: [id])
  @@index([sessionId, turnIndex])
}

model Badge {
  id        String   @id @default(cuid())
  userId    String
  code      String
  label     String
  issuedAt  DateTime @default(now())
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id])
  @@index([userId, expiresAt])
}

model MockOffer {
  id          String   @id @default(cuid())
  userId      String
  companyName String
  roleLabel   String
  title       String
  salaryText  String
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        NotificationType
  title       String
  body        String
  scheduledAt DateTime?
  sentAt      DateTime?
  readAt      DateTime?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
}


model MarketingEvent {
  id        String   @id @default(cuid())
  event     String
  source    String?
  path      String?
  userAgent String?
  ip        String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([event, createdAt])
}
